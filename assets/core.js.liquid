/* *********************************************************
 * Add all site functions here 
 * and add them to both the scripts.js and editor.js files
 * - Only init barba on front-end script (not editor.js)
 *   so be sure to add any new functionality to both files
 * ********************************************************* */

// Sitewide Init Functions
initCartDrawer();
initNavigation();

/* ***********************
 * Sitewide Functions
 * *********************** */
function initNavigation() {
  // Enable sticky nav
  if (document.querySelector('.site-header').classList.contains('is-sticky')) {
    ScrollTrigger.create({
      trigger: ".site-header",
      pin: ".site-header",
      start: "top",
      end: 99999,
      // markers: true,
    });
  }
};

function initCartDrawer() {
  // Opens Cart
  document.querySelector('.js-open-cart').addEventListener('click', function(e) {
    e.preventDefault();
    gsap.to('.cart-drawer', 0.35, {autoAlpha: 1, opacity: 1});
  });

  // Closes Cart
  document.querySelector('.js-close-cart').addEventListener('click', function(e) {
    e.preventDefault();
    gsap.to('.cart-drawer', 0.35, {autoAlpha: 0, opacity: 0});
  });

  // Removes item from cart drawer list (WIP)
};

// Allows WP Links to operate normally
// document.querySelectorAll("#wpadminbar a").forEach(item=>item.setAttribute('data-barba-prevent','self'));

/* ********************************
 * Pagewide Init Functions
 * ******************************** */
var initSingleProduct = function() {
  console.log('on product page');
  // controls for quantity sliders
  bindQuantityCount();
  bindVariantOptions();

  bindGalleryControls();
};

var initCartPage = function() {
  console.log('on cart page');
  // controls for quantity sliders
  bindQuantityCount();
  bindVariantOptions();
};

var initContactPage = function() {
  console.log('on contact page');
};

var initCollectionPage = function() {
  console.log('on collection page');

  Shopify.queryParams = {};

  // Preserve existing query parameters
  if (location.search.length) {
      var params = location.search.substr(1).split('&');

      for (var i = 0; i < params.length; i++) {
        var keyValue = params[i].split('=');

        if (keyValue.length) {
          Shopify.queryParams[decodeURIComponent(keyValue[0])] = decodeURIComponent(keyValue[1]);
        }
      }
  }

  // Update sort_by query parameter on select change
  document.querySelector('#sort-by').addEventListener('change', function(e) {
    var value = e.target.value;

    Shopify.queryParams.sort_by = value;
    location.search = new URLSearchParams(Shopify.queryParams).toString();
  });
};

/* ********************************
 * Single Purpose Functions
 * ******************************** */
var bindQuantityCount = function() {
    console.log('bindQuantityCount');
    const addButtons = document.querySelectorAll('.js-add');
    addButtons.forEach(function (addButton) {
      addButton.addEventListener('click', function () {
        const th = this.closest('.sp-option').querySelector('.quantity__input');
        th.value = parseInt(th.value) + 1;
      });
    });

    const subButtons = document.querySelectorAll('.js-sub');
    subButtons.forEach(function (subButton) {
      subButton.addEventListener('click', function () {
        const th = this.closest('.sp-option').querySelector('.quantity__input');
        if (parseInt(th.value) > 1) th.value = parseInt(th.value) - 1;
      });
    });
};

var bindVariantOptions = function() {
  var productURL = document.querySelector('.single-product').dataset.producturl;

  fetch(productURL + '.js')
  .then(response => response.json())
  .then(product => {
    // Your code that uses the product data goes here
    // console.log(product);
    document.querySelectorAll('.sp-option input[type="radio"]').forEach(radio => {
      radio.addEventListener('change', () => {
        // find selected options
        var selectedOptions = [];

        document.querySelectorAll('.sp-option input[type="radio"]:checked').forEach(radio => {
          selectedOptions.push(radio.value)
        });

        // finding matched variant
        var matchedVariant = product.variants.find(variant => {
          var pass = true;

          for (var i = 0; i < selectedOptions.length; i++) {
            if (selectedOptions.indexOf(variant.options[i]) === -1) {
              pass = false;
              break;
            }
          }

          return pass;
        })

        console.log('new product', matchedVariant);

        // change hidden input
        document.querySelector('#productId').value = matchedVariant.id;

        // change url
        var url = new URLParse(window.location.href, true);
        url.query.variant = matchedVariant.id;
        window.history.replaceState(null, null, url.toString());

        // change price
        var moneyFormat = document.querySelector('.sp-price').dataset.moneyformat;
        document.querySelector('.sp-price').textContent = formatMoney(matchedVariant.price, moneyFormat);
        document.querySelector('.sp-compare-price').textContent = formatMoney(matchedVariant.compare_at_price, moneyFormat);

        // toggle price classes
        matchedVariant.compare_at_price > matchedVariant.price ? 
          document.querySelector('.sp-compare-price').classList.remove('hidden') : 
          document.querySelector('.sp-compare-price').classList.add('hidden')

        // change image
        if (matchedVariant.featured_image) {
          document.querySelector('#productImage').setAttribute('src', matchedVariant.featured_image.src);
          document.querySelector('.sp-gallery-thumbs li.active').classList.remove('active');
          document.querySelectorAll('.sp-gallery-thumbs li')[matchedVariant.featured_image.position - 1].classList.add('active');
        }

        // change button
        var add = document.querySelector('#addToCart');

        if (matchedVariant.available) {
          // set add to cart button text
          add.textContent = 'Add to Cart';

          // enable form fields 
          document.querySelectorAll('.js-disable-field').forEach(input => {
            input.disabled = false;
          });

          document.querySelectorAll('.sp-option input[type="radio"]:checked').forEach(radio => {
          selectedOptions.push(radio.value)
        });
        } else {
          // set add to cart button text
          add.textContent = 'Out of Stock';

          // disable form fields
          document.querySelectorAll('.js-disable-field').forEach(input => {
            input.disabled = true;
          });
        }
      });
    });
  })
  .catch(error => {
    console.error('Error fetching product data:', error);
  });
};

var bindGalleryControls = function() {
  document.querySelectorAll('.sp-gallery-thumbs li').forEach(li => {
    li.addEventListener('click', () => {
      document.querySelector('.sp-gallery-thumbs li.active').classList.remove('active');
      li.classList.add('active');

      document.querySelector('#productImage').src = li.querySelector('img').getAttribute('src');
    });
  });
};



/* ********************************
 * Utility Functions
 * ******************************** */
// ---------------------------------------------------------------------------
// Money format handler
// ---------------------------------------------------------------------------
var formatMoney = function(cents, format) {
  if (typeof cents == 'string') { cents = cents.replace('.',''); }
  var value = '';
  var placeholderRegex = /\{\{\s*(\w+)\s*\}\}/;
  var formatString = (format || this.money_format);

  function defaultOption(opt, def) {
     return (typeof opt == 'undefined' ? def : opt);
  }

  function formatWithDelimiters(number, precision, thousands, decimal) {
    precision = defaultOption(precision, 2);
    thousands = defaultOption(thousands, ',');
    decimal   = defaultOption(decimal, '.');

    if (isNaN(number) || number == null) { return 0; }

    number = (number/100.0).toFixed(precision);

    var parts   = number.split('.'),
        dollars = parts[0].replace(/(\d)(?=(\d\d\d)+(?!\d))/g, '$1' + thousands),
        cents   = parts[1] ? (decimal + parts[1]) : '';

    return dollars + cents;
  }

  switch(formatString.match(placeholderRegex)[1]) {
    case 'amount':
      value = formatWithDelimiters(cents, 2);
      break;
    case 'amount_no_decimals':
      value = formatWithDelimiters(cents, 0);
      break;
    case 'amount_with_comma_separator':
      value = formatWithDelimiters(cents, 2, '.', ',');
      break;
    case 'amount_no_decimals_with_comma_separator':
      value = formatWithDelimiters(cents, 0, '.', ',');
      break;
  }

  return formatString.replace(placeholderRegex, value);
};